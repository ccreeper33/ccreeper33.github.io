<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha256-yIDrPSXHZdOZhAqiBP7CKzIwMQmRCJ8UeB8Jo17YC4o=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.28/fancybox/fancybox.css" integrity="sha256-6cQIC71/iBIYXFK+0RHAvwmjwWzkWd+r7v/BX3/vZDc=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-material.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.ccreeper.xyz","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.19.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"flat"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":true,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="è€ƒå®Œç ”æƒ³ç»™è‡ªå·±çš„ç®€å†é•€é‡‘ï¼ˆçŒæ°´ï¼Ÿï¼‰ï¼Œäºæ˜¯æƒ³åšä¸€ä¸‹å¤§åé¼é¼çš„ MIT 6.5840(or 6.824) ã€‚ç†è®ºçŸ¥è¯†å’Œæ¡†æ¶éƒ½åœ¨âš¡ğŸ§±çš„è¯¾ç¨‹ä¸­å­¦ä¹ å’Œä½¿ç”¨è¿‡ï¼Œæ‰€ä»¥å¯¹äº lectures å°±å¿«é€Ÿæµè§ˆäº†ç¿»è¯‘ç‰ˆæœ¬ï¼Œç›´æ¥è¿›å…¥ projects é˜¶æ®µï¼š">
<meta property="og:type" content="article">
<meta property="og:title" content="MIT 6.5840(6.824) - lab 1: MapReduce">
<meta property="og:url" content="https://blog.ccreeper.xyz/2024/02/16/MIT6-824-lab1/">
<meta property="og:site_name" content="ccreeper">
<meta property="og:description" content="è€ƒå®Œç ”æƒ³ç»™è‡ªå·±çš„ç®€å†é•€é‡‘ï¼ˆçŒæ°´ï¼Ÿï¼‰ï¼Œäºæ˜¯æƒ³åšä¸€ä¸‹å¤§åé¼é¼çš„ MIT 6.5840(or 6.824) ã€‚ç†è®ºçŸ¥è¯†å’Œæ¡†æ¶éƒ½åœ¨âš¡ğŸ§±çš„è¯¾ç¨‹ä¸­å­¦ä¹ å’Œä½¿ç”¨è¿‡ï¼Œæ‰€ä»¥å¯¹äº lectures å°±å¿«é€Ÿæµè§ˆäº†ç¿»è¯‘ç‰ˆæœ¬ï¼Œç›´æ¥è¿›å…¥ projects é˜¶æ®µï¼š">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.ccreeper.xyz/2024/02/16/MIT6-824-lab1/mapred_paper.png">
<meta property="article:published_time" content="2024-02-16T13:37:42.000Z">
<meta property="article:modified_time" content="2024-02-20T15:25:24.273Z">
<meta property="article:author" content="ccreeper">
<meta property="article:tag" content="åˆ†å¸ƒå¼">
<meta property="article:tag" content="csdiy">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.ccreeper.xyz/2024/02/16/MIT6-824-lab1/mapred_paper.png">


<link rel="canonical" href="https://blog.ccreeper.xyz/2024/02/16/MIT6-824-lab1/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.ccreeper.xyz/2024/02/16/MIT6-824-lab1/","path":"2024/02/16/MIT6-824-lab1/","title":"MIT 6.5840(6.824) - lab 1: MapReduce"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>MIT 6.5840(6.824) - lab 1: MapReduce | ccreeper</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">ccreeper</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="æœç´¢" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾<span class="badge">6</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»<span class="badge">3</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£<span class="badge">3</span></a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%98%85%E8%AF%BB%E8%AE%BA%E6%96%87"><span class="nav-number">1.</span> <span class="nav-text">é˜…è¯»è®ºæ–‡</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E6%9E%90%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B"><span class="nav-number">1.1.</span> <span class="nav-text">åˆ†ææ‰§è¡Œè¿‡ç¨‹</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Action-1-%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="nav-number">1.1.1.</span> <span class="nav-text">Action 1 å‡†å¤‡å·¥ä½œ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Action-2-%E8%A7%92%E8%89%B2%E5%88%92%E5%88%86"><span class="nav-number">1.1.2.</span> <span class="nav-text">Action 2 è§’è‰²åˆ’åˆ†</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Action-3-4-map%E4%BB%BB%E5%8A%A1%E9%98%B6%E6%AE%B5"><span class="nav-number">1.1.3.</span> <span class="nav-text">Action 3 - 4 mapä»»åŠ¡é˜¶æ®µ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Action-5-6-reduce%E4%BB%BB%E5%8A%A1%E9%98%B6%E6%AE%B5"><span class="nav-number">1.1.4.</span> <span class="nav-text">Action 5 - 6 reduceä»»åŠ¡é˜¶æ®µ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Action-7"><span class="nav-number">1.1.5.</span> <span class="nav-text">Action 7</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%B9%E9%94%99"><span class="nav-number">1.2.</span> <span class="nav-text">å®¹é”™</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#worker%E6%95%85%E9%9A%9C"><span class="nav-number">1.2.1.</span> <span class="nav-text">workeræ•…éšœ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#master-%E6%95%85%E9%9A%9C"><span class="nav-number">1.2.2.</span> <span class="nav-text">master æ•…éšœ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Semantics-in-the-Presence-of-Failures"><span class="nav-number">1.2.3.</span> <span class="nav-text">Semantics in the Presence of Failures</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E8%BF%87%E7%A8%8B"><span class="nav-number">2.</span> <span class="nav-text">å®ç°è¿‡ç¨‹</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E5%AE%9A%E4%B9%89"><span class="nav-number">2.1.</span> <span class="nav-text">æ•°æ®ç±»å‹å®šä¹‰</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%BB%E5%8A%A1%E4%BF%A1%E6%81%AF"><span class="nav-number">2.1.1.</span> <span class="nav-text">ä»»åŠ¡ä¿¡æ¯</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Coordinator"><span class="nav-number">2.1.2.</span> <span class="nav-text">Coordinator</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RPC%E6%95%B0%E6%8D%AE"><span class="nav-number">2.1.3.</span> <span class="nav-text">RPCæ•°æ®</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Worker%E8%AE%BE%E8%AE%A1"><span class="nav-number">2.2.</span> <span class="nav-text">Workerè®¾è®¡</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Coordinator%E8%AE%BE%E8%AE%A1"><span class="nav-number">2.3.</span> <span class="nav-text">Coordinatorè®¾è®¡</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BACoordinator"><span class="nav-number">2.3.1.</span> <span class="nav-text">åˆ›å»ºCoordinator</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%9F%E6%88%90-map-%E4%BB%BB%E5%8A%A1"><span class="nav-number">2.3.2.</span> <span class="nav-text">ç”Ÿæˆ map ä»»åŠ¡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%9F%E6%88%90-reduce-%E4%BB%BB%E5%8A%A1"><span class="nav-number">2.3.3.</span> <span class="nav-text">ç”Ÿæˆ reduce ä»»åŠ¡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BE%97%E5%87%BA%E8%BE%93%E5%87%BA%E6%96%87%E4%BB%B6-%E5%88%A0%E9%99%A4%E4%B8%AD%E9%97%B4%E6%96%87%E4%BB%B6"><span class="nav-number">2.3.4.</span> <span class="nav-text">å¾—å‡ºè¾“å‡ºæ–‡ä»¶ &amp; åˆ é™¤ä¸­é—´æ–‡ä»¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%84%E7%90%86-worker%E8%AF%B7%E6%B1%82"><span class="nav-number">2.3.5.</span> <span class="nav-text">å¤„ç† workerè¯·æ±‚</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C"><span class="nav-number">3.</span> <span class="nav-text">æµ‹è¯•ç»“æœ</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8%E5%88%86%E6%9E%90"><span class="nav-number">3.1.</span> <span class="nav-text">å¼‚å¸¸åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#job-count-test"><span class="nav-number">3.1.1.</span> <span class="nav-text">job count test</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#crash-test"><span class="nav-number">3.1.2.</span> <span class="nav-text">crash test</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">ccreeper</p>
  <div class="site-description" itemprop="description">You Only Live Once</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">3</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/ccreeper33" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;ccreeper33" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="è¿”å›é¡¶éƒ¨">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
        <div class="pjax">
        </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.ccreeper.xyz/2024/02/16/MIT6-824-lab1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ccreeper">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ccreeper">
      <meta itemprop="description" content="You Only Live Once">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="MIT 6.5840(6.824) - lab 1: MapReduce | ccreeper">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          MIT 6.5840(6.824) - lab 1: MapReduce<a href="https://github.com/user-name/repo-name/tree/branch-name/subdirectory-name/_posts/MIT6-824-lab1.md" class="post-edit-link" title="ç¼–è¾‘" rel="noopener" target="_blank"><i class="fa fa-pen-nib"></i></a>
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2024-02-16 21:37:42" itemprop="dateCreated datePublished" datetime="2024-02-16T21:37:42+08:00">2024-02-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2024-02-20 23:25:24" itemprop="dateModified" datetime="2024-02-20T23:25:24+08:00">2024-02-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%A6%E7%82%B9%E6%96%B0%E4%B8%9C%E8%A5%BF/" itemprop="url" rel="index"><span itemprop="name">å­¦ç‚¹æ–°ä¸œè¥¿</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="é˜…è¯»æ¬¡æ•°" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°ï¼š</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>è€ƒå®Œç ”æƒ³ç»™è‡ªå·±çš„ç®€å†é•€é‡‘ï¼ˆçŒæ°´ï¼Ÿï¼‰ï¼Œäºæ˜¯æƒ³åšä¸€ä¸‹å¤§åé¼é¼çš„ MIT 6.5840(or 6.824) ã€‚ç†è®ºçŸ¥è¯†å’Œæ¡†æ¶éƒ½åœ¨âš¡ğŸ§±çš„è¯¾ç¨‹ä¸­å­¦ä¹ å’Œä½¿ç”¨è¿‡ï¼Œæ‰€ä»¥å¯¹äº lectures å°±å¿«é€Ÿæµè§ˆäº†<a target="_blank" rel="noopener" href="https://mit-public-courses-cn-translatio.gitbook.io/mit6-824/">ç¿»è¯‘ç‰ˆæœ¬</a>ï¼Œç›´æ¥è¿›å…¥ projects é˜¶æ®µï¼š</p>
<span id="more"></span>

<h1 id="é˜…è¯»è®ºæ–‡"><a href="#é˜…è¯»è®ºæ–‡" class="headerlink" title="é˜…è¯»è®ºæ–‡"></a>é˜…è¯»è®ºæ–‡</h1><p><a target="_blank" rel="noopener" href="http://research.google.com/archive/mapreduce-osdi04.pdf">MapReduce è®ºæ–‡</a>ä¸­ç»™å‡ºäº†åœ¨ä¸€ä¸ªç”±å¤§é‡æ¶ˆè´¹çº§ PC å’Œç½‘ç»œç»„æˆçš„é›†ç¾¤ä¸Šå®ç° MapReduce çš„æ€è·¯ã€‚ç„¶è€Œ lab 1 ä¸­è¦æ±‚çš„ç¯å¢ƒæ˜¯åœ¨å•æœºä¸Šï¼Œä½¿ç”¨è¿›ç¨‹æ¨¡æ‹Ÿçš„åˆ†å¸ƒå¼ç¯å¢ƒï¼Œæ‰€ä»¥å®Œå…¨ç…§æ¬è®ºæ–‡æ€è·¯ä¼¼ä¹å¹¶ä¸åˆç†ã€‚<del>ï¼ˆå¦ï¼Œlab 1 ä¸­å°†è®ºæ–‡çš„ master ç§°ä¸º coordinator æ˜¯å¦æœ‰ç‚¹å¤ªè¿‡æ”¿æ²»æ­£ç¡®äº†â€¦â€¦ï¼‰</del></p>
<h2 id="åˆ†ææ‰§è¡Œè¿‡ç¨‹"><a href="#åˆ†ææ‰§è¡Œè¿‡ç¨‹" class="headerlink" title="åˆ†ææ‰§è¡Œè¿‡ç¨‹"></a>åˆ†ææ‰§è¡Œè¿‡ç¨‹</h2><blockquote>
<p>We have given you a little code to start you off. The â€œmainâ€ routines for the coordinator and worker are in <code>main/mrcoordinator.go</code> and <code>main/mrworker.go</code>; donâ€™t change these files. You should put your implementation in <code>mr/coordinator.go</code>,<code> mr/worker.go</code>, and <code>mr/rpc.go</code>. </p>
</blockquote>
<p>lab ä¸­ç»™å‡ºäº†åŸºæœ¬çš„æ‰§è¡Œæ¡†æ¶ï¼Œä¸è®ºæ–‡ä¸­çš„ç•¥æœ‰åŒºåˆ«ã€‚æ­£å¦‚è®ºæ–‡ä¸­æåˆ°çš„ï¼Œ</p>
<blockquote>
<p>Many different implementations of the MapReduce interface are possible. The right choice depends on the environment. </p>
</blockquote>
<p>labçš„è¿è¡Œç¯å¢ƒä¸è®ºæ–‡ä¸­å¹¶ä¸ç›¸åŒã€‚éœ€è¦å®ç°çš„å†…å®¹é›†ä¸­åœ¨ <code>mr/coordinator.go</code> <code> mr/worker.go</code> <code>mr/rpc.go</code>ä¸‰ä¸ªæ–‡ä»¶ä¸­ã€‚</p>
<p><img src="/2024/02/16/MIT6-824-lab1/mapred_paper.png" alt="è®ºæ–‡ä¸­çš„æ‰§è¡Œè¿‡ç¨‹"></p>
<h3 id="Action-1-å‡†å¤‡å·¥ä½œ"><a href="#Action-1-å‡†å¤‡å·¥ä½œ" class="headerlink" title="Action 1 å‡†å¤‡å·¥ä½œ"></a>Action 1 å‡†å¤‡å·¥ä½œ</h3><blockquote>
<p>The MapReduce library in the user program first splits the input files into M pieces of typically 16 megabytes to 64 megabytes (MB) per piece (controllable by the user via an optional parameter). It then starts up many copies of the program on a cluster of machines.</p>
</blockquote>
<p>è®ºæ–‡ä¸­çš„ç¬¬ä¸€æ­¥ï¼Œç”±ç”¨æˆ·ç¨‹åºè°ƒç”¨MapReduceåº“ï¼Œå°†è¾“å…¥æ–‡ä»¶åˆ†å‰²ä¸ºMä¸ª16-64MB çš„å—ï¼ˆå¯¹åº”åç»­äº§ç”Ÿçš„Mä¸ªmapä»»åŠ¡ï¼‰ï¼Œç„¶ååœ¨é›†ç¾¤ä¸­forkå‡ºå¤šä»½ç¨‹åºçš„å‰¯æœ¬ï¼Œå…¶ä¸­ä¸€ä¸ªä¸ºMasterï¼Œå…¶ä½™ä¸ºWorkerã€‚</p>
<p>è€Œlabä¸­ï¼Œç”¨æˆ·ç¨‹åºå¯¹åº”äº†<code>main/mrcoordinator.go</code>ï¼ˆåˆ›å»ºcoordinatorè¿›ç¨‹ï¼‰<code>main/mrworker.go</code>ï¼ˆåˆ›å»ºworkerè¿›ç¨‹ï¼‰<code>test-mr.sh</code>ï¼ˆæ‰§è¡Œè„šæœ¬ï¼‰<code>mrapps/*.go</code>ï¼ˆå®šä¹‰map&#x2F;reduceå‡½æ•°ï¼Œä»¥<a target="_blank" rel="noopener" href="https://pkg.go.dev/plugin">Go plugin</a>çš„å½¢å¼åŠ è½½è‡³workerï¼‰ã€‚è¿™ä¸€éƒ¨åˆ†å‡ä¸ºç»™å®šçš„ä»£ç ï¼Œä¸éœ€è¦è‡ªå·±å®ç°ã€‚å¯¹äºæ–‡ä»¶åˆ†å‰²ï¼Œlabä¸­ç»™å‡ºçš„æ–¹æ¡ˆæ˜¯ç›´æ¥æŒ‰ç…§æ–‡ä»¶æ‰§è¡Œmapä»»åŠ¡ï¼Œä¸éœ€è¦åˆ†å‰²ã€‚</p>
<h3 id="Action-2-è§’è‰²åˆ’åˆ†"><a href="#Action-2-è§’è‰²åˆ’åˆ†" class="headerlink" title="Action 2 è§’è‰²åˆ’åˆ†"></a>Action 2 è§’è‰²åˆ’åˆ†</h3><blockquote>
<p>One of the copies of the program is special â€“ the master. The rest are workers that are assigned work by the master. There are M map tasks and R reduce tasks to assign. The master picks idle workers and assigns each one a map task or a reduce task.</p>
</blockquote>
<p>è®ºæ–‡ä¸­ï¼Œç”±masteræŒ‡å®šç©ºé—²çš„workeræ¥æ‰§è¡Œä»»åŠ¡ã€‚è€Œlabä¸­ï¼Œç”±workerï¼ˆé€šè¿‡RPCï¼‰å‘coordinatorè¯·æ±‚ä»»åŠ¡å¹¶æ‰§è¡Œã€‚</p>
<h3 id="Action-3-4-mapä»»åŠ¡é˜¶æ®µ"><a href="#Action-3-4-mapä»»åŠ¡é˜¶æ®µ" class="headerlink" title="Action 3 - 4 mapä»»åŠ¡é˜¶æ®µ"></a>Action 3 - 4 mapä»»åŠ¡é˜¶æ®µ</h3><blockquote>
<p>A worker who is assigned a map task reads the contents of the corresponding input split. It parses key&#x2F;value pairs out of the input data and passes each<br>pair to the user-defined Map function. The intermediate key&#x2F;value pairs produced by the Map function are buffered in memory. </p>
</blockquote>
<blockquote>
<p>Periodically, the buffered pairs are written to local disk, partitioned into R regions by the partitioning function. The locations of these buffered pairs on<br>the local disk are passed back to the master, who is responsible for forwarding these locations to the reduce workers.</p>
</blockquote>
<p>è¿™ä¸€æ­¥ä¸­map workerè¯»å…¥è¾“å…¥æ–‡ä»¶ï¼Œæ‰§è¡Œmapå‡½æ•°ï¼Œå¹¶ç»™å‡ºä¸­é—´æ•°æ®ã€‚</p>
<p>è®ºæ–‡ä¸­ï¼Œè¾“å…¥è¾“å‡ºæ•°æ®ä¿å­˜åœ¨<code> a global file system</code>ï¼Œæˆ–è€…åœ¨è¿™ä¸ªç¯å¢ƒä¸‹åº”å½“ç‰¹æŒ‡GFSã€‚ç±»ä¼¼åœ°ï¼Œhadoopå°†MapReduceçš„è¾“å…¥è¾“å‡ºæ•°æ®å­˜æ”¾åœ¨HDFSä¸­ã€‚</p>
<p>è€Œmap workeräº§ç”Ÿçš„ä¸­é—´æ•°æ®å­˜æ”¾åœ¨map workerçš„å†…å­˜ï¼Œå†å®šæœŸåœ°å°†å…¶åˆ†ä¸ºRä»½ï¼ˆå¯¹åº”reduceä»»åŠ¡æ•°é‡ï¼‰ä¿å­˜åœ¨æœ¬åœ°ç¡¬ç›˜ã€‚ç„¶åå°†ä¸­é—´æ•°æ®çš„ä½ç½®è¿”å›è‡³masterï¼Œå¹¶è¿›ä¸€æ­¥ç”±masteré€šçŸ¥reduce workeråº”è¯¥ä»å“ªé‡Œè·å–æ•°æ®ã€‚</p>
<p>å¯¹äºlabï¼Œè¿™éƒ¨åˆ†æ­£æ˜¯éœ€è¦å®ç°çš„ã€‚è€ƒè™‘labçš„å•æœºç¯å¢ƒåŠè¾ƒå°çš„æ•°æ®è§„æ¨¡ï¼Œæ¯”èµ·å®é™…çš„é›†ç¾¤åº”å½“æ›´å®¹æ˜“å®ç°ã€‚</p>
<h3 id="Action-5-6-reduceä»»åŠ¡é˜¶æ®µ"><a href="#Action-5-6-reduceä»»åŠ¡é˜¶æ®µ" class="headerlink" title="Action 5 - 6 reduceä»»åŠ¡é˜¶æ®µ"></a>Action 5 - 6 reduceä»»åŠ¡é˜¶æ®µ</h3><blockquote>
<p>When a reduce worker is notified by the master about these locations, it uses remote procedure calls to read the buffered data from the local disks of the map workers. When a reduce worker has read all intermediate data, it sorts it by the intermediate keys so that all occurrences of the same key are grouped together. The sorting is needed because typically many different keys map to the same reduce task. If the amount of intermediate data is too large to fit in memory, an external sort is used. </p>
</blockquote>
<blockquote>
<p>The reduce worker iterates over the sorted intermediate data and for each unique intermediate key encountered, it passes the key and the corresponding<br>set of intermediate values to the userâ€™s Reduce function. The output of the Reduce function is appended to a final output file for this reduce partition.</p>
</blockquote>
<p>è¿™ä¸€æ­¥ä¸­ï¼Œreduce workerè¯»å–ä¸­é—´æ•°æ®ï¼Œæ‰§è¡Œreduceå‡½æ•°ï¼Œå¹¶å¾—å‡ºæœ€ç»ˆçš„è¾“å‡ºæ–‡ä»¶ã€‚åŒæ ·çš„ï¼Œè¿™ä¸€éƒ¨åˆ†æ˜¯éœ€è¦å®ç°çš„ã€‚</p>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè®ºæ–‡æåˆ°äº†è¶…å‡ºå†…å­˜èŒƒå›´æ—¶ï¼Œéœ€è¦ä½¿ç”¨å¤–éƒ¨æ’åºï¼Œä½†æ˜¯ç»™å‡ºçš„æ ·ä¾‹ç¨‹åº<code>main/mrsequential.go</code>å¹¶æ²¡æœ‰å®ç°è¶…å‡ºå†…å­˜èŒƒå›´çš„å¤„ç†æ–¹å¼ï¼Œå®Œå…¨è¿è¡Œäºå†…å­˜ä¸­ã€‚ æ•…åº”å½“ä¸ç”¨è€ƒè™‘è¶…å‡ºå†…å­˜èŒƒå›´çš„æ•°æ®ï¼ˆæ­£å¦‚ä¸Šæ–‡ï¼Œlabçš„æ•°æ®è§„æ¨¡è¿˜æ˜¯æ¯”è¾ƒå‹å¥½çš„ï¼‰ã€‚</p>
<h3 id="Action-7"><a href="#Action-7" class="headerlink" title="Action 7"></a>Action 7</h3><blockquote>
<p>When all map tasks and reduce tasks have been completed, the master wakes up the user program. At this point, the MapReduce call in the user program returns back to the user code.</p>
</blockquote>
<p>è®ºæ–‡ä¸­ï¼Œæ‰§è¡Œå®ŒMapReduceè°ƒç”¨åï¼Œå†æ¬¡è¿”å›ç”¨æˆ·ç¨‹åºï¼›è€Œlabä¸­ä¸å­˜åœ¨ç”¨æˆ·ç¨‹åºã€‚</p>
<h2 id="å®¹é”™"><a href="#å®¹é”™" class="headerlink" title="å®¹é”™"></a>å®¹é”™</h2><p>è®ºæ–‡ä¸­æåˆ°äº†ä¸‰ç±»å®¹é”™ï¼š</p>
<h3 id="workeræ•…éšœ"><a href="#workeræ•…éšœ" class="headerlink" title="workeræ•…éšœ"></a>workeræ•…éšœ</h3><p>è®ºæ–‡ä¸­ï¼Œmasteré€šè¿‡å®šæœŸpingæ¥ç¡®è®¤workerå­˜æ´»çŠ¶æ€ã€‚å¦‚æœè¶…æ—¶æœªå“åº”åˆ™è§†ä¸ºworkerå¤±æ•ˆã€‚</p>
<table>
<thead>
<tr>
<th align="center">ä»»åŠ¡è¿›åº¦\å¤±æ•ˆç±»å‹</th>
<th align="center">map worker å¤±æ•ˆ</th>
<th align="center">reduce worker å¤±æ•ˆ</th>
</tr>
</thead>
<tbody><tr>
<td align="center">å·²å®Œæˆ</td>
<td align="center">å¯¹åº”ä»»åŠ¡é‡æ–°æ‰§è¡Œ</td>
<td align="center">æ— éœ€é‡æ–°æ‰§è¡Œ</td>
</tr>
<tr>
<td align="center">å¤„ç†ä¸­</td>
<td align="center">å¯¹åº”ä»»åŠ¡é‡æ–°æ‰§è¡Œ</td>
<td align="center">å¯¹åº”ä»»åŠ¡é‡æ–°æ‰§è¡Œ</td>
</tr>
</tbody></table>
<p>æ­£å¦‚ä¸Šæ–‡æåˆ°çš„ï¼Œmap&#x2F;reduce workeräº§ç”Ÿçš„æ•°æ®å­˜æ”¾äºä¸åŒä½ç½®ã€‚æ‰€ä»¥å¯¹äºå·²å®Œæˆçš„ä»»åŠ¡ï¼Œå¦‚æœæ˜¯mapä»»åŠ¡ï¼Œéœ€è¦é‡æ–°æ‰§è¡Œï¼ˆå› ä¸ºäº§ç”Ÿçš„æ•°æ®å­˜å‚¨åœ¨workeræœ¬åœ°ç£ç›˜ï¼‰ï¼›è€Œå¯¹äºreduceäººç‰©ï¼Œåˆ™æ— éœ€é‡æ–°æ‰§è¡Œï¼ˆå…¶æ•°æ®å­˜å‚¨ä»¥åˆ†å¸ƒå¼å¤šå‰¯æœ¬çš„å½¢å¼å­˜å‚¨äºé›†ç¾¤ä¸­ã€‚</p>
<p>å¯¹äºlabï¼Œå–å†³äºå®ç°æ–¹å¼ï¼Œéœ€è¦ä»¥ä¸åŒæ–¹å¼å¤„ç†workeræ•…éšœï¼šå¦‚æœä¸è®ºæ–‡ä¸€æ ·ï¼Œä¸­é—´æ•°æ®å­˜äºç¡¬ç›˜ï¼Œåˆ™<strong>ä¸</strong>éœ€è¦é‡æ–°æ‰§è¡Œå·²å®Œæˆçš„mapä»»åŠ¡ï¼ˆæ˜¾ç„¶ï¼Œåœ¨å•æœºç¯å¢ƒä¸‹ä¸ç”¨æ‹…å¿ƒworkerå¤±æ•ˆåä¸¢å¤±ä¸­é—´æ–‡ä»¶ï¼‰ï¼›å¦‚æœä¸­é—´æ•°æ®å­˜äºå†…å­˜ï¼Œåˆ™éœ€è¦é‡æ–°æ‰§è¡Œã€‚</p>
<p>åŒæ—¶ï¼Œlabä¸­å¯¹äºåˆ¤æ–­workerå¤±æ•ˆæœ‰ç€ä¸åŒçš„æ–¹å¼ã€‚</p>
<blockquote>
<p>The coordinator should notice if a worker hasnâ€™t completed its task in a reasonable amount of time (for this lab, use ten seconds), and give the same task to a different worker.</p>
</blockquote>
<p>ä¸åŒäºè®ºæ–‡çš„pingï¼Œlabä½¿ç”¨å®Œæˆæ—¶é—´åˆ¤æ–­workerçŠ¶æ€ï¼ˆå…·ä½“åˆ¤æ–­æ–¹æ³•æœ‰å¾…å®ç°ï¼‰ï¼ˆæ˜¾ç„¶ä¸èƒ½æ˜¯pingï¼‰ã€‚</p>
<h3 id="master-æ•…éšœ"><a href="#master-æ•…éšœ" class="headerlink" title="master æ•…éšœ"></a>master æ•…éšœ</h3><p>è®ºæ–‡ä¸­æåˆ°ï¼Œå¯ä»¥é€šè¿‡å®šæœŸä¿å­˜masterçŠ¶æ€çš„checkpointæ¥é‡å»ºå¤±æ•ˆçš„masterï¼Œä½†æ˜¯å¯¹äºåªæœ‰ä¸€å°çš„masteråº”å½“ä¸å®¹æ˜“å¤±æ•ˆï¼Œæ‰€ä»¥è®ºæ–‡ä¸è€ƒè™‘masterçš„å®¹é”™ã€‚</p>
<p>è€Œlabæ•´ä½“éƒ½æ˜¯è¿è¡Œäºå•æœºçš„ï¼Œäº‹å®ä¸Šä¸éœ€è¦è€ƒè™‘å®¹é”™ï¼ˆä¸Šæ–‡ä¸­çš„workeræ•…éšœä¸ºé¢˜ç›®è¦æ±‚çš„åˆ¤æ–­æ–¹å¼ï¼‰ã€‚</p>
<h3 id="Semantics-in-the-Presence-of-Failures"><a href="#Semantics-in-the-Presence-of-Failures" class="headerlink" title="Semantics in the Presence of Failures"></a>Semantics in the Presence of Failures</h3><p>å³å¯¹äºå…·æœ‰ç¡®å®šæ€§çš„Mapå’ŒReduceæ“ä½œï¼ŒMapReduceæ‰§è¡Œçš„ç»“æœåº”å½“ä¸é¡ºåºæ‰§è¡Œçš„ç»“æœç›¸åŒï¼›è€Œå¯¹äºä¸å…·ç¡®å®šæ€§çš„æ“ä½œï¼ŒMapReduceåº”å½“<strong>ç­‰ä»·äº</strong>ï¼ˆä½†ä¸ä¸€å®šç›¸åŒï¼‰é¡ºåºæ‰§è¡Œï¼ˆè€ƒè™‘ç”Ÿæˆéšæœºæ•°çš„æ“ä½œï¼Œæ˜¾ç„¶è¯­ä¹‰ä¸Šç›¸åŒçš„æ‰§è¡Œå¹¶ä¸ä¸€å®šå¾—åˆ°ç›¸åŒç»“æœï¼‰ã€‚è¿™æ˜¯ç”±MapReduceçš„æ‰§è¡Œè¿‡ç¨‹å†³å®šçš„ã€‚</p>
<h1 id="å®ç°è¿‡ç¨‹"><a href="#å®ç°è¿‡ç¨‹" class="headerlink" title="å®ç°è¿‡ç¨‹"></a>å®ç°è¿‡ç¨‹</h1><h2 id="æ•°æ®ç±»å‹å®šä¹‰"><a href="#æ•°æ®ç±»å‹å®šä¹‰" class="headerlink" title="æ•°æ®ç±»å‹å®šä¹‰"></a>æ•°æ®ç±»å‹å®šä¹‰</h2><p> é¦–å…ˆåº”å½“æ˜ç¡®ï¼Œè¦å®ç°ä¸€ä¸ªMapReduceæ¡†æ¶ï¼Œéœ€è¦ç»´æŠ¤&#x2F;ä¼ é€’å“ªäº›æ•°æ®ï¼š</p>
<h3 id="ä»»åŠ¡ä¿¡æ¯"><a href="#ä»»åŠ¡ä¿¡æ¯" class="headerlink" title="ä»»åŠ¡ä¿¡æ¯"></a>ä»»åŠ¡ä¿¡æ¯</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> MrTask <span class="keyword">struct</span> &#123;</span><br><span class="line">	Id             <span class="type">int</span></span><br><span class="line">	CreateTime     <span class="type">int64</span></span><br><span class="line">	NReduce        <span class="type">int</span></span><br><span class="line">	Type           TaskType</span><br><span class="line">	Status         MrTaskStatus</span><br><span class="line">	InputFileName  <span class="type">string</span></span><br><span class="line">	InterFileNames []<span class="type">string</span></span><br><span class="line">	OutputFileName <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> TaskType <span class="type">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	Map TaskType = <span class="literal">iota</span></span><br><span class="line">	Reduce</span><br><span class="line">	NoMoreTasks</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> MrTaskStatus <span class="type">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	Idle MrTaskStatus = <span class="literal">iota</span></span><br><span class="line">	InProgress</span><br><span class="line">	Completed</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>ä¸å·¥ä½œåœ¨GFS &#x2F; HDFSä¸Šçš„MapReduceç±»ä¼¼ï¼Œæˆ‘ä»¬çš„å®ç°ä¹Ÿæ˜¯åœ¨åŒä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼ˆæœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼‰ä¸Šçš„ã€‚ä»»åŠ¡ä¿¡æ¯é€šè¿‡RPCä¼ é€’ï¼Œè€Œä»»åŠ¡æ•°æ®åˆ™é€šè¿‡æ–‡ä»¶ä¼ è¾“ã€‚</p>
<p>ä¸‰ä¸ªFileName(s)å­—æ®µä¸­ï¼ŒMapä»»åŠ¡éœ€è¦è¯»å–<code>InputFileName</code>ï¼Œè¾“å‡º<code>InterFileNames</code>ï¼›Reduceä»»åŠ¡è¯»å–<code>InterFileNames</code>ï¼Œè¾“å‡º<code>OutputFileName</code>ã€‚</p>
<p>å¦å¤–ï¼Œå¼•å…¥<code>CreateTime</code>æ˜¯ä¸ºäº†ç¡®è®¤å”¯ä¸€çš„ä»»åŠ¡ï¼ˆæˆ–è€…è¯´ä»»åŠ¡çš„ä¸€æ¬¡æ‰§è¡Œï¼‰ã€‚å› ä¸ºä»»åŠ¡åœ¨è¶…æ—¶ï¼ˆlabä¸­è¦æ±‚çš„10ç§’ï¼‰åæ‰ä¼šé‡æ–°æŒ‡å®šworkeræ‰§è¡Œï¼Œæ‰€ä»¥<code>Id</code>å’Œ<code>CreateTime</code>ä¸€å®šå¯ä»¥ç¡®è®¤å”¯ä¸€çš„ä¸€æ¬¡ä»»åŠ¡æ‰§è¡Œã€‚</p>
<h3 id="Coordinator"><a href="#Coordinator" class="headerlink" title="Coordinator"></a>Coordinator</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Coordinator <span class="keyword">struct</span> &#123;</span><br><span class="line">	inputFileNames []<span class="type">string</span></span><br><span class="line">	nReduce        <span class="type">int</span>              <span class="comment">// number of reduce tasks</span></span><br><span class="line">	workerTimeOut  time.Duration    <span class="comment">// time to re-assign tasks, default 10s</span></span><br><span class="line">	state          coordinatorState <span class="comment">// coordinator state</span></span><br><span class="line">	tasks          [][]MrTask       <span class="comment">// mapreduce tasks, example: task[Map][taskId]</span></span><br><span class="line">	taskCount      <span class="type">int</span>              <span class="comment">// the number of tasks which are not completed</span></span><br><span class="line">	taskLock       sync.Mutex       <span class="comment">// lock for update Task Status</span></span><br><span class="line">	taskChannel    <span class="keyword">chan</span> MrTask      <span class="comment">// channel to assign Idle tasks</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> coordinatorState <span class="type">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	creating coordinatorState = <span class="literal">iota</span></span><br><span class="line">	mapping</span><br><span class="line">	reducing</span><br><span class="line">	done</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>ä¸è®ºæ–‡ä¸­æåˆ°çš„ç±»ä¼¼ï¼Œmaster(coordinator)ç»´æŠ¤äº†å…³äºæ•´ä¸ªMapReduceç¨‹åºå’Œæ¯ä¸ªä»»åŠ¡çš„ä¿¡æ¯ã€‚taskChannelæœ¬èº«ç”±äºgo channelçš„ç‰¹æ€§ï¼Œå¯ä»¥ä¿è¯äº’æ–¥ï¼Œè€Œå…¶ä»–ä»»åŠ¡ä¿¡æ¯åˆ™éœ€è¦äº’æ–¥é”taskLockå®ç°äº’æ–¥è®¿é—®ã€‚</p>
<h3 id="RPCæ•°æ®"><a href="#RPCæ•°æ®" class="headerlink" title="RPCæ•°æ®"></a>RPCæ•°æ®</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> GetTaskArgs <span class="keyword">struct</span> &#123;</span><br><span class="line">	Nothing <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> GetTaskReply <span class="keyword">struct</span> &#123;</span><br><span class="line">	Task MrTask</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ReportTaskArgs <span class="keyword">struct</span> &#123;</span><br><span class="line">	Task MrTask</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> ReportTaskReply <span class="keyword">struct</span> &#123;</span><br><span class="line">	Nothing <span class="type">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>RPCåªæ¶‰åŠä¸¤ç§æƒ…å†µï¼š</p>
<ul>
<li>Workerå‘Coordinatorè¯·æ±‚ä»»åŠ¡</li>
<li>Workerå‘Coordinatoræ±‡æŠ¥ä»»åŠ¡</li>
</ul>
<p>äºŒè€…å‡åªéœ€è¦ä¼ é€’ä¸€æ¡ä»»åŠ¡ä¿¡æ¯ï¼Œä¸”æ— è®ºä»»åŠ¡æˆè´¥å‡ä¸Workeræ— å…³ï¼Œè€Œæ˜¯ç”±Coordinatoræ¥å†³å®šã€‚æ‰€ä»¥è¿™é‡Œä½¿ç”¨<code>Nothing</code>å ä½ï¼Œè€Œä¸éœ€è¦çœŸçš„æœ‰å‚æ•°&#x2F;è¯·æ±‚ã€‚</p>
<h2 id="Workerè®¾è®¡"><a href="#Workerè®¾è®¡" class="headerlink" title="Workerè®¾è®¡"></a>Workerè®¾è®¡</h2><p>æ­£å¦‚å…¶åï¼Œworkeråªéœ€è¦workã€‚å®ƒæ‰€éœ€è¦åšçš„å°±æ˜¯è¯·æ±‚ä»»åŠ¡-&gt;æ‰§è¡Œä»»åŠ¡-&gt;æ±‡æŠ¥ä»»åŠ¡ï¼Œä¸æ–­å¾ªç¯ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main/mrworker.go calls this function.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Worker</span><span class="params">(mapFunc <span class="keyword">func</span>(<span class="type">string</span>, <span class="type">string</span>)</span></span> []KeyValue,</span><br><span class="line">	reduceFunc <span class="function"><span class="keyword">func</span><span class="params">(<span class="type">string</span>, []<span class="type">string</span>)</span></span> <span class="type">string</span>) &#123;</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		task := getTaskCall()</span><br><span class="line">		<span class="keyword">if</span> task.Type == Map &#123;</span><br><span class="line">			<span class="comment">// read from input file</span></span><br><span class="line">			file, err := os.Open(task.InputFileName)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Fatalf(<span class="string">&quot;cannot open %v&quot;</span>, task.InputFileName)</span><br><span class="line">			&#125;</span><br><span class="line">			content, err := io.ReadAll(file)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Fatalf(<span class="string">&quot;cannot read %v&quot;</span>, task.InputFileName)</span><br><span class="line">			&#125;</span><br><span class="line">			err = file.Close()</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Fatalf(<span class="string">&quot;cannot close %v: %v&quot;</span>, task.InputFileName, err)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// run map function</span></span><br><span class="line">			keyValues := mapFunc(task.InputFileName, <span class="type">string</span>(content))</span><br><span class="line"></span><br><span class="line">			<span class="comment">// split intermediate data into R(or NReduce) pieces</span></span><br><span class="line">			interDatas := <span class="built_in">make</span>([][]KeyValue, <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; task.NReduce; i++ &#123;</span><br><span class="line">				interDatas = <span class="built_in">append</span>(interDatas, <span class="built_in">make</span>([]KeyValue, <span class="number">0</span>))</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">for</span> _, kv := <span class="keyword">range</span> keyValues &#123;</span><br><span class="line">				index := ihash(kv.Key) % task.NReduce</span><br><span class="line">				interDatas[index] = <span class="built_in">append</span>(interDatas[index], kv)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// serialize and write intermediate file</span></span><br><span class="line">			<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; task.NReduce; i++ &#123;</span><br><span class="line">				<span class="keyword">var</span> buffer bytes.Buffer</span><br><span class="line">				enc := gob.NewEncoder(&amp;buffer)</span><br><span class="line">				err := enc.Encode(interDatas[i])</span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">					log.Fatal(<span class="string">&quot;encode error:&quot;</span>, err)</span><br><span class="line">				&#125;</span><br><span class="line">				interFileName := fmt.Sprintf(<span class="string">&quot;mr-map-%v-reduce-%v-%v&quot;</span>, task.Id, i, task.CreateTime)</span><br><span class="line">				file, err := os.Create(interFileName)</span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">					log.Fatalf(<span class="string">&quot;cannot create %v&quot;</span>, interFileName)</span><br><span class="line">				&#125;</span><br><span class="line">				_, err = file.Write(buffer.Bytes())</span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">					log.Fatalf(<span class="string">&quot;cannot write %v&quot;</span>, interFileName)</span><br><span class="line">				&#125;</span><br><span class="line">				err = file.Close()</span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">					log.Fatalf(<span class="string">&quot;cannot close %v&quot;</span>, interFileName)</span><br><span class="line">				&#125;</span><br><span class="line">				task.InterFileNames = <span class="built_in">append</span>(task.InterFileNames, interFileName)</span><br><span class="line">			&#125;</span><br><span class="line">			task.Status = Completed</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> task.Type == Reduce &#123;</span><br><span class="line">			<span class="comment">// read and deserialize intermedia data</span></span><br><span class="line">			<span class="keyword">var</span> interData []KeyValue</span><br><span class="line">			interNum := <span class="built_in">len</span>(task.InterFileNames)</span><br><span class="line">			<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; interNum; i++ &#123;</span><br><span class="line">				<span class="keyword">var</span> buffer bytes.Buffer</span><br><span class="line">				dec := gob.NewDecoder(&amp;buffer)</span><br><span class="line">				interFileName := task.InterFileNames[i]</span><br><span class="line">				file, err := os.Open(interFileName)</span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">					log.Fatalf(<span class="string">&quot;cannot open %v&quot;</span>, interFileName)</span><br><span class="line">				&#125;</span><br><span class="line">				content, err := io.ReadAll(file)</span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">					log.Fatalf(<span class="string">&quot;cannot read %v&quot;</span>, interFileName)</span><br><span class="line">				&#125;</span><br><span class="line">				err = file.Close()</span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">					log.Fatalf(<span class="string">&quot;cannot close %v&quot;</span>, interFileName)</span><br><span class="line">				&#125;</span><br><span class="line">				buffer.Write(content)</span><br><span class="line">				<span class="keyword">var</span> data []KeyValue</span><br><span class="line">				err = dec.Decode(&amp;data)</span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">					log.Fatal(<span class="string">&quot;decode error:&quot;</span>, err)</span><br><span class="line">				&#125;</span><br><span class="line">				interData = <span class="built_in">append</span>(interData, data...)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// prepare (Key, list(Value)) for reduce function</span></span><br><span class="line">			kvMap := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>][]<span class="type">string</span>)</span><br><span class="line">			<span class="keyword">for</span> _, kv := <span class="keyword">range</span> interData &#123;</span><br><span class="line">				elem, ok := kvMap[kv.Key]</span><br><span class="line">				<span class="keyword">if</span> ok &#123;</span><br><span class="line">					kvMap[kv.Key] = <span class="built_in">append</span>(elem, kv.Value)</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					kvMap[kv.Key] = []<span class="type">string</span>&#123;kv.Value&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// run reduce function</span></span><br><span class="line">			outputString := <span class="string">&quot;&quot;</span></span><br><span class="line">			<span class="keyword">for</span> key, values := <span class="keyword">range</span> kvMap &#123;</span><br><span class="line">				outputString += fmt.Sprintf(<span class="string">&quot;%v %v\n&quot;</span>, key, reduceFunc(key, values))</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// write output file</span></span><br><span class="line">			outputFileName := fmt.Sprintf(<span class="string">&quot;mr-out-%v-%v&quot;</span>, task.Id, task.CreateTime)</span><br><span class="line">			file, err := os.Create(outputFileName)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Fatalf(<span class="string">&quot;cannot create %v&quot;</span>, outputFileName)</span><br><span class="line">			&#125;</span><br><span class="line">			_, err = file.WriteString(outputString)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Fatalf(<span class="string">&quot;cannot write %v&quot;</span>, outputFileName)</span><br><span class="line">			&#125;</span><br><span class="line">			err = file.Close()</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Fatalf(<span class="string">&quot;cannot close %v&quot;</span>, outputFileName)</span><br><span class="line">			&#125;</span><br><span class="line">			task.OutputFileName = outputFileName</span><br><span class="line">			task.Status = Completed</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> task.Type == NoMoreTasks &#123;</span><br><span class="line">			os.Exit(<span class="number">0</span>)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// report Task</span></span><br><span class="line">		ReportTaskCall(task)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å€¼å¾—æ³¨æ„çš„æ˜¯ä¸­é—´æ–‡ä»¶&#x2F;è¾“å‡ºæ–‡ä»¶çš„å‘½åï¼šäºŒè€…å‡è¿½åŠ äº†æ—¶é—´æˆ³ï¼Œç”¨äºé¿å…å†²çªã€‚è€Œæœ€ç»ˆæ˜¯å¦å°†ä¸­é—´æ–‡ä»¶ç”¨äºç”Ÿæˆreduceä»»åŠ¡&#x2F;å°†è¾“å‡ºæ–‡ä»¶ç¡®è®¤ä¸ºæœ€ç»ˆç»“æœï¼ˆåˆ å»æ–‡ä»¶åçš„æ—¶é—´æˆ³ï¼‰ï¼Œéƒ½äº¤ç”±coordinatorå†³å®šã€‚</p>
<h2 id="Coordinatorè®¾è®¡"><a href="#Coordinatorè®¾è®¡" class="headerlink" title="Coordinatorè®¾è®¡"></a>Coordinatorè®¾è®¡</h2><p>ç›¸è¾ƒäºé€»è¾‘éå¸¸ç®€å•çš„Workerï¼ŒCoordinatorçš„ä»»åŠ¡è¾ƒä¸ºå¤æ‚ã€‚éœ€è¦ç”Ÿæˆä»»åŠ¡ã€åˆ†é…ä»»åŠ¡ã€åˆ¤æ–­ä»»åŠ¡æ˜¯å¦æ­£å¸¸å®Œæˆç­‰ã€‚å…¶ä¸­é™¤äº†ç”Ÿæˆä»»åŠ¡çš„éƒ¨åˆ†ä»¥å¤–å‡éœ€è¦å¹¶å‘ã€‚</p>
<pre><code class="highlight mermaid">graph LR
	genmap((ç”Ÿæˆ map ä»»åŠ¡))--&gt;map1(æ‰§è¡Œ map ä»»åŠ¡)--&gt;genred((ç”Ÿæˆ reduce ä»»åŠ¡))--&gt;red1(æ‰§è¡Œ reduce ä»»åŠ¡)--&gt;fin((å®Œæˆ MapReduce))
	genmap--&gt;map2(æ‰§è¡Œ map ä»»åŠ¡)--&gt;genred
	genmap--&gt;map3(æ‰§è¡Œ map ä»»åŠ¡)--&gt;genred
	genred--&gt;red2(æ‰§è¡Œ reduce ä»»åŠ¡)--&gt;fin
	genred--&gt;red3(æ‰§è¡Œ reduce ä»»åŠ¡)--&gt;fin</code></pre>



<h3 id="åˆ›å»ºCoordinator"><a href="#åˆ›å»ºCoordinator" class="headerlink" title="åˆ›å»ºCoordinator"></a>åˆ›å»ºCoordinator</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// create a Coordinator.</span></span><br><span class="line"><span class="comment">// main/mrcoordinator.go calls this function.</span></span><br><span class="line"><span class="comment">// NReduce is the number of reduce tasks to use.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MakeCoordinator</span><span class="params">(files []<span class="type">string</span>, nReduce <span class="type">int</span>)</span></span> *Coordinator &#123;</span><br><span class="line">	c := Coordinator&#123;</span><br><span class="line">		inputFileNames: files,</span><br><span class="line">		nReduce:        nReduce,</span><br><span class="line">		workerTimeOut:  time.Second * <span class="number">10</span>,</span><br><span class="line">		state:          creating,</span><br><span class="line">		tasks:          [][]MrTask&#123;<span class="built_in">make</span>([]MrTask, <span class="number">0</span>), <span class="built_in">make</span>([]MrTask, <span class="number">0</span>)&#125;,</span><br><span class="line">		taskLock:       sync.Mutex&#123;&#125;,</span><br><span class="line">		taskChannel:    <span class="built_in">make</span>(<span class="keyword">chan</span> MrTask, max_(<span class="built_in">len</span>(files), nReduce)+<span class="number">1</span>),</span><br><span class="line">	&#125;</span><br><span class="line">	c.taskLock.Lock()</span><br><span class="line">	c.generateMapTasks()</span><br><span class="line">	c.taskLock.Unlock()</span><br><span class="line">	c.server()</span><br><span class="line">	<span class="keyword">return</span> &amp;c</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºcoordinatorï¼Œç”Ÿæˆmapä»»åŠ¡ï¼Œè¿è¡ŒRPCæœåŠ¡ç«¯ã€‚</p>
<h3 id="ç”Ÿæˆ-map-ä»»åŠ¡"><a href="#ç”Ÿæˆ-map-ä»»åŠ¡" class="headerlink" title="ç”Ÿæˆ map ä»»åŠ¡"></a>ç”Ÿæˆ map ä»»åŠ¡</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Coordinator)</span></span> generateMapTasks() &#123;</span><br><span class="line">	taskNumber := <span class="built_in">len</span>(c.inputFileNames)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; taskNumber; i++ &#123;</span><br><span class="line">		task := MrTask&#123;</span><br><span class="line">			Id:             i,</span><br><span class="line">			CreateTime:     time.Now().Unix(),</span><br><span class="line">			NReduce:        c.nReduce,</span><br><span class="line">			Type:           Map,</span><br><span class="line">			Status:         Idle,</span><br><span class="line">			InputFileName:  c.inputFileNames[i],</span><br><span class="line">			InterFileNames: <span class="built_in">make</span>([]<span class="type">string</span>, <span class="number">0</span>),</span><br><span class="line">		&#125;</span><br><span class="line">		c.tasks[Map] = <span class="built_in">append</span>(c.tasks[Map], task)</span><br><span class="line">	&#125;</span><br><span class="line">	c.taskCount = taskNumber</span><br><span class="line">	c.state = mapping</span><br><span class="line">	<span class="keyword">for</span> _, task := <span class="keyword">range</span> c.tasks[Map] &#123;</span><br><span class="line">		c.taskChannel &lt;- task</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ç”Ÿæˆ-reduce-ä»»åŠ¡"><a href="#ç”Ÿæˆ-reduce-ä»»åŠ¡" class="headerlink" title="ç”Ÿæˆ reduce ä»»åŠ¡"></a>ç”Ÿæˆ reduce ä»»åŠ¡</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Coordinator)</span></span> generateReduceTasks() &#123;</span><br><span class="line">	mapTaskNumber := <span class="built_in">len</span>(c.inputFileNames)</span><br><span class="line">	reduceTaskNumber := c.nReduce</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; reduceTaskNumber; i++ &#123;</span><br><span class="line">		task := MrTask&#123;</span><br><span class="line">			Id:             i,</span><br><span class="line">			CreateTime:     time.Now().Unix(),</span><br><span class="line">			NReduce:        c.nReduce,</span><br><span class="line">			Type:           Reduce,</span><br><span class="line">			Status:         Idle,</span><br><span class="line">			InterFileNames: <span class="built_in">make</span>([]<span class="type">string</span>, <span class="number">0</span>),</span><br><span class="line">		&#125;</span><br><span class="line">		c.tasks[Reduce] = <span class="built_in">append</span>(c.tasks[Reduce], task)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// shuffle intermediate files</span></span><br><span class="line">	<span class="keyword">for</span> mapIndex := <span class="number">0</span>; mapIndex &lt; mapTaskNumber; mapIndex++ &#123;</span><br><span class="line">		<span class="keyword">for</span> reduceIndex := <span class="number">0</span>; reduceIndex &lt; reduceTaskNumber; reduceIndex++ &#123;</span><br><span class="line">			c.tasks[Reduce][reduceIndex].InterFileNames =</span><br><span class="line">				<span class="built_in">append</span>(c.tasks[Reduce][reduceIndex].InterFileNames,</span><br><span class="line">					c.tasks[Map][mapIndex].InterFileNames[reduceIndex])</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	c.taskCount = reduceTaskNumber</span><br><span class="line">	c.state = reducing</span><br><span class="line">	<span class="keyword">for</span> _, task := <span class="keyword">range</span> c.tasks[Reduce] &#123;</span><br><span class="line">		c.taskChannel &lt;- task</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å¾—å‡ºè¾“å‡ºæ–‡ä»¶-åˆ é™¤ä¸­é—´æ–‡ä»¶"><a href="#å¾—å‡ºè¾“å‡ºæ–‡ä»¶-åˆ é™¤ä¸­é—´æ–‡ä»¶" class="headerlink" title="å¾—å‡ºè¾“å‡ºæ–‡ä»¶ &amp; åˆ é™¤ä¸­é—´æ–‡ä»¶"></a>å¾—å‡ºè¾“å‡ºæ–‡ä»¶ &amp; åˆ é™¤ä¸­é—´æ–‡ä»¶</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CleanUp - remove intermedia files &amp; rename output files</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Coordinator)</span></span> CleanUp() &#123;</span><br><span class="line">	<span class="keyword">for</span> _, task := <span class="keyword">range</span> c.tasks[Reduce] &#123;</span><br><span class="line">		deleteFiles(task.InterFileNames)</span><br><span class="line">		renameFile(task.OutputFileName, fmt.Sprintf(<span class="string">&quot;mr-out-%v&quot;</span>, task.Id))</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="å¤„ç†-workerè¯·æ±‚"><a href="#å¤„ç†-workerè¯·æ±‚" class="headerlink" title="å¤„ç† workerè¯·æ±‚"></a>å¤„ç† workerè¯·æ±‚</h3><p>å¦‚ä¸Šæ–‡ï¼Œworkerä¼šåœ¨ä¸¤ç§æƒ…å†µä¸‹ä½¿ç”¨RPCå‘coordinatorå‘é€è¯·æ±‚ï¼š</p>
<ul>
<li><p>è·å–ä»»åŠ¡</p>
  <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Coordinator)</span></span> GetTask(args *GetTaskArgs, reply *GetTaskReply) <span class="type">error</span> &#123;</span><br><span class="line">    _ = args</span><br><span class="line">    c.taskLock.Lock()</span><br><span class="line">    <span class="keyword">defer</span> c.taskLock.Unlock()</span><br><span class="line">    <span class="keyword">if</span> c.state == done &#123;</span><br><span class="line">        reply.Task = MrTask&#123;Type: NoMoreTasks&#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        task := &lt;-c.taskChannel</span><br><span class="line">        c.tasks[task.Type][task.Id].Status = InProgress</span><br><span class="line">        <span class="keyword">go</span> c.taskTimeOut(&amp;c.tasks[task.Type][task.Id])</span><br><span class="line">        reply.Task = task</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Coordinator)</span></span> taskTimeOut(task *MrTask) &#123;</span><br><span class="line">    time.Sleep(c.workerTimeOut)</span><br><span class="line">    c.taskLock.Lock()</span><br><span class="line">    <span class="keyword">defer</span> c.taskLock.Unlock()</span><br><span class="line">    <span class="keyword">if</span> task.Status != Completed &#123;</span><br><span class="line">        <span class="comment">// worker time out, create a new task</span></span><br><span class="line">        task.Status = Idle</span><br><span class="line">        task.CreateTime = time.Now().Unix()</span><br><span class="line">        c.taskChannel &lt;- *task</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  å½“workerè·å–ä»»åŠ¡æ—¶ï¼Œcoordinatorçš„ä»»åŠ¡åˆ—è¡¨ä¸­ï¼Œä¼šå°†è¿™æ¬¡ä»»åŠ¡æ ‡è®°ä¸º<code>InProgress</code>ã€‚åŒæ—¶ï¼Œåˆ›å»ºä¸€ä¸ª go routine ç”¨äºè®¡æ—¶ã€‚å¦‚æœ10ç§’åï¼Œè¿™æ¬¡ä»»åŠ¡è¿˜æ²¡æœ‰å®Œæˆï¼Œåˆ™è§†ä¸ºå¤±è´¥ã€‚è¿™æ—¶ä¼šä½¿ç”¨ä¸€ä¸ªæ–°çš„æ—¶é—´æˆ³æ¥åˆ›å»ºæ–°çš„ä»»åŠ¡ï¼Œå¹¶æ”¾å…¥ç­‰å¾…æ‰§è¡Œçš„channelä¸­ã€‚</p>
</li>
<li><p>æ±‡æŠ¥ä»»åŠ¡</p>
  <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Coordinator)</span></span> ReportTask(args *ReportTaskArgs, reply *ReportTaskReply) <span class="type">error</span> &#123;</span><br><span class="line">	_ = reply</span><br><span class="line">	taskId := args.Task.Id</span><br><span class="line">	taskType := args.Task.Type</span><br><span class="line">	c.taskLock.Lock()</span><br><span class="line">	<span class="keyword">defer</span> c.taskLock.Unlock()</span><br><span class="line">	<span class="keyword">if</span> c.tasks[taskType][taskId].CreateTime == args.Task.CreateTime &#123;</span><br><span class="line">		<span class="comment">// completed in time, take as valid report</span></span><br><span class="line">		c.tasks[taskType][taskId] = args.Task</span><br><span class="line">		c.taskCount--</span><br><span class="line">		<span class="keyword">if</span> c.taskCount == <span class="number">0</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> c.state == mapping &#123;</span><br><span class="line">				c.generateReduceTasks()</span><br><span class="line">				c.state = reducing</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> c.state == reducing &#123;</span><br><span class="line">				c.CleanUp()</span><br><span class="line">				c.state = done</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// time out, invalid report</span></span><br><span class="line">		<span class="keyword">if</span> args.Task.Type == Map &#123;</span><br><span class="line">			deleteFiles(args.Task.InterFileNames)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			deleteFiles([]<span class="type">string</span>&#123;args.Task.OutputFileName&#125;)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  å¦‚æœæ±‡æŠ¥çš„ä»»åŠ¡ä¸coordinatorä¸­çš„æ—¶é—´æˆ³ä¸ç¬¦ï¼Œåˆ™è¡¨æ˜è¿™æ¬¡æ±‡æŠ¥çš„ä»»åŠ¡å·²ç»å› ä¸ºè¶…æ—¶ï¼Œè¢«å†æ¬¡åˆ†é…äº†ã€‚</p>
<p>  å¦‚æœæ—¶é—´æˆ³ç›¸ç¬¦ï¼Œåˆ™è¯æ˜æ˜¯ä¸€æ¬¡æˆåŠŸçš„ä»»åŠ¡æ‰§è¡Œã€‚è¿™æ—¶coordinatorä½¿ç”¨æ±‡æŠ¥çš„ä»»åŠ¡ä¿¡æ¯æ›¿æ¢è‡ªèº«ä¿å­˜çš„ä»»åŠ¡ä¿¡æ¯ã€‚</p>
<p>  å½“æ‰€æœ‰ä»»åŠ¡éƒ½è¢«æˆåŠŸæ‰§è¡Œåï¼ˆ<code>taskCount</code>å‡ä¸º0ï¼‰ï¼Œåˆ™coordinatorä¼šè½¬å…¥ä¸‹ä¸€ä¸ªå·¥ä½œé˜¶æ®µï¼šä»mappingåˆ°reducingï¼Œæˆ–è€…ä»reducingåˆ°doneã€‚</p>
</li>
</ul>
<h1 id="æµ‹è¯•ç»“æœ"><a href="#æµ‹è¯•ç»“æœ" class="headerlink" title="æµ‹è¯•ç»“æœ"></a>æµ‹è¯•ç»“æœ</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ bash test-mr.sh</span><br><span class="line">*** Starting <span class="built_in">wc</span> <span class="built_in">test</span>.</span><br><span class="line">--- <span class="built_in">wc</span> <span class="built_in">test</span>: PASS</span><br><span class="line">*** Starting indexer <span class="built_in">test</span>.</span><br><span class="line">--- indexer <span class="built_in">test</span>: PASS</span><br><span class="line">*** Starting map parallelism <span class="built_in">test</span>.</span><br><span class="line">--- map parallelism <span class="built_in">test</span>: PASS</span><br><span class="line">*** Starting reduce parallelism <span class="built_in">test</span>.</span><br><span class="line">--- reduce parallelism <span class="built_in">test</span>: PASS</span><br><span class="line">*** Starting job count <span class="built_in">test</span>.</span><br><span class="line">unexpected EOF</span><br><span class="line">unexpected EOF</span><br><span class="line">2024/02/20 21:04:09 Get Task failed!</span><br><span class="line">2024/02/20 21:04:09 Get Task failed!</span><br><span class="line">--- job count <span class="built_in">test</span>: PASS</span><br><span class="line">*** Starting early <span class="built_in">exit</span> <span class="built_in">test</span>.</span><br><span class="line">--- early <span class="built_in">exit</span> <span class="built_in">test</span>: PASS</span><br><span class="line">*** Starting crash <span class="built_in">test</span>.</span><br><span class="line">unexpected EOF</span><br><span class="line">unexpected EOF</span><br><span class="line">unexpected EOF</span><br><span class="line">2024/02/20 21:04:37 Get Task failed!</span><br><span class="line">2024/02/20 21:04:37 Get Task failed!</span><br><span class="line">2024/02/20 21:04:37 Get Task failed!</span><br><span class="line">--- crash <span class="built_in">test</span>: PASS</span><br><span class="line">*** PASSED ALL TESTS</span><br></pre></td></tr></table></figure>

<h2 id="å¼‚å¸¸åˆ†æ"><a href="#å¼‚å¸¸åˆ†æ" class="headerlink" title="å¼‚å¸¸åˆ†æ"></a>å¼‚å¸¸åˆ†æ</h2><p>åˆ°è¿™é‡Œå·²ç»å®Œæˆäº†æ‰€æœ‰çš„testï¼Œä½†æ˜¯å…¶ä¸­å‡ºç°çš„ä¸€äº›å¼‚å¸¸æœ‰äº›ç¢çœ¼ã€‚</p>
<p>unexpected EOF å’Œ Get Task failed! ä»…æˆå¯¹å‡ºç°äºcoordinatoræ—©äºworkerç»“æŸçš„æƒ…å†µï¼šcoordinatorå·²ç»å®ŒæˆMapReduceä»»åŠ¡ï¼Œå…³é—­RPCæœåŠ¡ç«¯ï¼›è€Œworkerä»ç„¶é€šè¿‡RPCå®¢æˆ·ç«¯å°è¯•è·å–ä»»åŠ¡ï¼Œå¯¼è‡´å¼‚å¸¸é€€å‡ºï¼ˆlog.Fatal(xxx)ï¼‰ã€‚</p>
<p>äº‹å®ä¸Šè¿™äº›å¼‚å¸¸å‡å‘ç”Ÿåœ¨MapReduceä»»åŠ¡ç»“æŸåï¼Œå¹¶ä¸ä¼šå½±å“æµ‹è¯•ç»“æœï¼Œä½†æ˜¯å¯¹äºä»£ç çš„ç²¾ç¥æ´ç™–ä¿ƒä½¿æˆ‘å°è¯•è§£å†³è¿™äº›å¼‚å¸¸ï¼š</p>
<h3 id="job-count-test"><a href="#job-count-test" class="headerlink" title="job count test"></a>job count test</h3><p>å…¶ä¸­ï¼Œjob count testå‡ºç°è¿™ä¸€é—®é¢˜æ˜¯å› ä¸º<code>test-mr.sh</code>ä¸­å°‘äº†ä¸€ä¸ª<code>&amp;</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">maybe_quiet <span class="variable">$TIMEOUT</span> ../mrworker ../../mrapps/jobcount.so &amp;</span><br><span class="line">maybe_quiet <span class="variable">$TIMEOUT</span> ../mrworker ../../mrapps/jobcount.so</span><br><span class="line">maybe_quiet <span class="variable">$TIMEOUT</span> ../mrworker ../../mrapps/jobcount.so &amp;</span><br><span class="line">maybe_quiet <span class="variable">$TIMEOUT</span> ../mrworker ../../mrapps/jobcount.so</span><br></pre></td></tr></table></figure>

<p>ç”±äºç¬¬äºŒä¸ªworkerä¸æ˜¯ä½¿ç”¨subshellåå°è¿è¡Œï¼Œå¯¼è‡´å‰ä¸¤ä¸ªworkerç»“æŸåæ‰ä¼šå¯åŠ¨åä¸¤ä¸ªworkerã€‚è€Œå‰ä¸¤ä¸ªworkerä¸coordinatorå‡ ä¹åŒæ—¶ç»“æŸï¼ˆworkeråœ¨æ‰§è¡Œå®Œæœ€åä¸€ä¸ªä»»åŠ¡åï¼Œæ”¶åˆ°<code>NoMoreTasks</code>ç»“æŸï¼›coordinatoråœ¨<code>src/main/mrcoordinator.go</code>å‘ç°ä»»åŠ¡ç»“æŸåè¢«ç»“æŸï¼‰ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(os.Args) &lt; <span class="number">2</span> &#123;</span><br><span class="line">		fmt.Fprintf(os.Stderr, <span class="string">&quot;Usage: mrcoordinator inputfiles...\n&quot;</span>)</span><br><span class="line">		os.Exit(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	m := mr.MakeCoordinator(os.Args[<span class="number">1</span>:], <span class="number">10</span>)</span><br><span class="line">	<span class="keyword">for</span> m.Done() == <span class="literal">false</span> &#123;</span><br><span class="line">		time.Sleep(time.Second)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	time.Sleep(time.Second)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥åä¸¤ä¸ªworkerè·å–ä»»åŠ¡å¤±è´¥ã€‚</p>
<p>è§£å†³æ–¹æ¡ˆï¼šåœ¨ç¬¬äºŒä¸ªmrworkeråæ·»åŠ <code>&amp;</code></p>
<h3 id="crash-test"><a href="#crash-test" class="headerlink" title="crash test"></a>crash test</h3><p>crash test ä¸­çš„å¼‚å¸¸æˆå› ç±»ä¼¼ï¼Œä½†å¹¶ä¸å®Œå…¨æ˜¯æµ‹è¯•è„šæœ¬çš„é—®é¢˜ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -f mr-done</span><br><span class="line">((maybe_quiet <span class="variable">$TIMEOUT2</span> ../mrcoordinator ../pg*txt); touch mr-done ) &amp;</span><br><span class="line">sleep <span class="number">1</span></span><br><span class="line"></span><br><span class="line"># start multiple workers</span><br><span class="line">maybe_quiet <span class="variable">$TIMEOUT2</span> ../mrworker ../../mrapps/crash.so &amp;</span><br><span class="line"></span><br><span class="line"># mimic rpc.go&#x27;s coordinatorSock()</span><br><span class="line">SOCKNAME=/var/tmp/<span class="number">5840</span>-mr-`id -u`</span><br><span class="line"></span><br><span class="line">( while [ -e <span class="variable">$SOCKNAME</span> -a ! -f mr-done ]</span><br><span class="line">  do</span><br><span class="line">    maybe_quiet <span class="variable">$TIMEOUT2</span> ../mrworker ../../mrapps/crash.so</span><br><span class="line">    sleep <span class="number">1</span></span><br><span class="line">  done ) &amp;</span><br><span class="line"></span><br><span class="line">( while [ -e <span class="variable">$SOCKNAME</span> -a ! -f mr-done ]</span><br><span class="line">  do</span><br><span class="line">    maybe_quiet <span class="variable">$TIMEOUT2</span> ../mrworker ../../mrapps/crash.so</span><br><span class="line">    sleep <span class="number">1</span></span><br><span class="line">  done ) &amp;</span><br><span class="line"></span><br><span class="line">while [ -e <span class="variable">$SOCKNAME</span> -a ! -f mr-done ]</span><br><span class="line">do</span><br><span class="line">  maybe_quiet <span class="variable">$TIMEOUT2</span> ../mrworker ../../mrapps/crash.so</span><br><span class="line">  sleep <span class="number">1</span></span><br><span class="line">done</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™ä¸ªtestä¸­ï¼Œä½¿ç”¨ä¸‰ä¸ªwhileæ¥å¯åŠ¨workerï¼šå½“workerç»“æŸ<strong>ä¸€ç§’</strong>åï¼Œåªè¦coordinatoræ²¡æœ‰ç»“æŸï¼Œå°±å†æ¬¡å¯åŠ¨workerã€‚</p>
<p>ä½†æ˜¯<code>src/main/mrcoordinator.go</code>ä¸­ï¼Œè°ƒç”¨<code>m.Done()</code>åsleepä¸€ç§’ï¼Œå½“è¿”å›å€¼ä¸ºtrueæ—¶å†sleepä¸€ç§’ï¼šå¿½ç•¥æ‰§è¡Œæ—¶é—´ï¼Œå½“<code>coordinator.State</code>è¢«è®¾ä¸º<code>done</code>åçš„<strong>1-2ç§’</strong>ï¼Œcoordinatorè¢«ç»“æŸã€‚</p>
<p>è€Œcoordinatorçš„å®ç°ä¸­ï¼Œåªç»“æŸäº†è¿è¡Œå®Œæœ€åä¸€ä¸ªä»»åŠ¡æ—¶è¢«é˜»å¡çš„workerï¼Œå¹¶æ²¡æœ‰è€ƒè™‘åˆ°è¿™ä¹‹åçš„workerã€‚</p>
<p>è¿™é‡Œæˆ‘çš„å®ç°æ€è·¯ä¸æµ‹è¯•ä»£ç æš—å«çš„å‡ºé¢˜äººçš„æ€è·¯ä¸åŒï¼Œæˆ‘ä¸ªäººè®¤ä¸ºä¸¤ç§æ€è·¯åº”å½“éƒ½æ˜¯æ­£ç¡®çš„ï¼šæˆ‘çš„æ€è·¯å€¾å‘äºåœ¨workeræ­£å¸¸ç»“æŸåä¸ä¼šäº§ç”Ÿæ–°çš„workerï¼›è€Œå‡ºé¢˜äººä¼¼ä¹è®¤ä¸ºworkerä¸ä¼šä¸»åŠ¨ç»“æŸï¼Œåªè¦ç»“æŸå°±åº”å½“æ˜¯crashã€‚</p>
<p>è§£å†³æ–¹æ¡ˆæœ‰ä¸¤ç§ï¼š</p>
<ol>
<li>å°†æµ‹è¯•è„šæœ¬ä¸­çš„<code>sleep 1</code>æ”¹ä¸º<code>sleep 2</code></li>
<li>ä½¿coordinatoræŒç»­å‘<code>taskChannel</code>è¾“å…¥<code>MrTask&#123;Type: NoMoreTasks&#125;</code>ï¼Œä»¥ç»“æŸåç»­æ‰€æœ‰çš„workerã€‚ï¼ˆä¸Šä¸€ä¸ªé—®é¢˜ä¹Ÿå¯ä»¥è¢«è¿™ä¸€æ–¹æ¡ˆè§£å†³ï¼Œä½†æ˜¯testçš„é€»è¾‘ç¡®å®æœ‰é—®é¢˜ï¼Œæ‰€ä»¥ä»ç„¶åº”å½“æŒ‰ç…§ä¸Šæ–‡ä¿®æ”¹æµ‹è¯•ä»£ç ï¼‰</li>
</ol>
<p>ä¿®æ”¹åæµ‹è¯•ç»“æœå®Œå…¨æ­£å¸¸ï¼ˆå¯ç”¨äº†goçš„race detectorï¼‰ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ bash test-mr.sh</span><br><span class="line">*** Starting <span class="built_in">wc</span> <span class="built_in">test</span>.</span><br><span class="line">--- <span class="built_in">wc</span> <span class="built_in">test</span>: PASS</span><br><span class="line">*** Starting indexer <span class="built_in">test</span>.</span><br><span class="line">--- indexer <span class="built_in">test</span>: PASS</span><br><span class="line">*** Starting map parallelism <span class="built_in">test</span>.</span><br><span class="line">--- map parallelism <span class="built_in">test</span>: PASS</span><br><span class="line">*** Starting reduce parallelism <span class="built_in">test</span>.</span><br><span class="line">--- reduce parallelism <span class="built_in">test</span>: PASS</span><br><span class="line">*** Starting job count <span class="built_in">test</span>.</span><br><span class="line">--- job count <span class="built_in">test</span>: PASS</span><br><span class="line">*** Starting early <span class="built_in">exit</span> <span class="built_in">test</span>.</span><br><span class="line">--- early <span class="built_in">exit</span> <span class="built_in">test</span>: PASS</span><br><span class="line">*** Starting crash <span class="built_in">test</span>.</span><br><span class="line">--- crash <span class="built_in">test</span>: PASS</span><br><span class="line">*** PASSED ALL TESTS</span><br></pre></td></tr></table></figure>


    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" rel="tag"><i class="fa fa-tag"></i> åˆ†å¸ƒå¼</a>
              <a href="/tags/csdiy/" rel="tag"><i class="fa fa-tag"></i> csdiy</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/10/15/A%E6%B5%8B%E9%80%9F%E9%80%9A/" rel="prev" title="Aæµ‹é€Ÿé€š">
                  <i class="fa fa-angle-left"></i> Aæµ‹é€Ÿé€š
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">ccreeper</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="æ€»è®¿å®¢é‡">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="æ€»è®¿é—®é‡">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div><!-- Cloudflare Web Analytics -->
<script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "603a4f443b224d768309bdee7f7400f9"}'></script>
<!-- End Cloudflare Web Analytics -->


    </div>
  </footer>

  

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.28/fancybox/fancybox.umd.js" integrity="sha256-ytMJGN3toR+a84u7g7NuHm91VIR06Q41kMWDr2pq7Zo=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  
  <script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"https://cdnjs.cloudflare.com/ajax/libs/pdfobject/2.2.12/pdfobject.min.js","integrity":"sha256-g2xji1rlE3KsGVClvuxTbcR0Kn2+wtQADSff2Tbb4zA="},"url":"/lib/pdf/web/viewer"}</script>
  <script src="/js/third-party/tags/pdf.js"></script>

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.6.1/mermaid.min.js","integrity":"sha256-mm3Re3y7xlvh+yCD+l/Zs1d+PU0AEad93MkWvljfm/s="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>


  <script src="/js/third-party/fancybox.js"></script>

  <script src="/js/third-party/pace.js"></script>


  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
